package module

import (
	"context"
	"encoding/hex"
	"math/big"
	"strings"
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/rlp"
	"github.com/hyperledger-labs/yui-relayer/log"
	"github.com/stretchr/testify/suite"
)

type HeaderQueryTestSuite struct {
	suite.Suite
	forkSpecsPatterns [][]*ForkSpec
}

func TestHeaderQueryTestSuite(t *testing.T) {
	suite.Run(t, new(HeaderQueryTestSuite))
}

func (ts *HeaderQueryTestSuite) SetupTest() {
	err := log.InitLogger("DEBUG", "text", "stdout", false)
	ts.Require().NoError(err)
	ts.forkSpecsPatterns = [][]*ForkSpec{
		{{
			HeightOrTimestamp:        &ForkSpec_Height{Height: 0},
			KAncestorGenerationDepth: 1,
		}},
		{{
			HeightOrTimestamp:        &ForkSpec_Height{Height: 0},
			KAncestorGenerationDepth: 3,
		}},
	}
}

func (ts *HeaderQueryTestSuite) TestErrorQueryFinalizedHeader() {

	ts.Require().NoError(log.InitLogger("INFO", "json", "stdout", false))
	fn := func(ctx context.Context, height uint64) (*types.Header, error) {
		return &types.Header{
			Number: big.NewInt(int64(height)),
		}, nil
	}

	for _, forkSpecs := range ts.forkSpecsPatterns {
		// No finalized header found
		headers, err := queryFinalizedHeader(context.Background(), fn, 1, 10, forkSpecs)
		ts.Require().NoError(err)
		ts.Require().Nil(headers)

		fn = func(ctx context.Context, height uint64) (*types.Header, error) {
			h := headerByHeight(int64(height))
			if h != nil {
				return h, nil
			}
			return &types.Header{Number: big.NewInt(int64(height))}, nil
		}

		headers, err = queryFinalizedHeader(context.Background(), fn, 760, 1000, forkSpecs)
		ts.Require().NoError(err)
		ts.Require().Nil(headers)
	}

}

func (ts *HeaderQueryTestSuite) TestSuccessQueryFinalizedHeader() {
	ts.Require().NoError(log.InitLogger("INFO", "json", "stdout", false))
	fn := func(ctx context.Context, height uint64) (*types.Header, error) {
		h := headerByHeight(int64(height))
		if h != nil {
			return h, nil
		}
		return &types.Header{Number: big.NewInt(int64(height))}, nil
	}

	for _, forkSpecs := range ts.forkSpecsPatterns {
		headers, err := queryFinalizedHeader(context.Background(), fn, 761, 1003, forkSpecs)
		ts.Require().NoError(err)
		ts.Require().Len(headers, 1003-761, len(headers))
	}
}

func (ts *HeaderQueryTestSuite) TestSuccessQueryLatestFinalizedHeader() {

	verify := func(latestBlockNumber uint64, forkSpecs []*ForkSpec) {
		getHeader := func(ctx context.Context, height uint64) (*types.Header, error) {
			h := headerByHeight(int64(height))
			if h != nil {
				return h, nil
			}
			return &types.Header{Number: big.NewInt(int64(height))}, nil
		}
		height, h, err := queryLatestFinalizedHeader(context.Background(), getHeader, latestBlockNumber, forkSpecs)
		ts.Require().NoError(err)
		ts.Require().Len(h, 3)
		ts.Require().Equal(int(height), 1001)
	}
	for _, forkSpecs := range ts.forkSpecsPatterns {
		for i := 1003; i < 1003+100; i++ {
			verify(uint64(i), forkSpecs)
		}
	}
}

func (ts *HeaderQueryTestSuite) TestErrorQueryLatestFinalizedHeader_NoVote() {

	verify := func(latestBlockNumber uint64, extra []byte, forkSpecs []*ForkSpec) {
		getHeader := func(ctx context.Context, height uint64) (*types.Header, error) {
			return &types.Header{
				Number: big.NewInt(int64(height)),
				Extra:  extra,
			}, nil
		}
		_, _, err := queryLatestFinalizedHeader(context.Background(), getHeader, latestBlockNumber, forkSpecs)
		ts.Require().True(strings.Contains(err.Error(), "no finalized header found"))
	}

	for _, forkSpecs := range ts.forkSpecsPatterns {
		for i := 0; i < 100; i++ {
			verify(uint64(i), make([]byte, 0), forkSpecs)
			verify(uint64(i), common.Hex2Bytes("d88301020b846765746888676f312e32302e35856c696e7578000000b19df4a2f8b5831defffb860a44482b16993815ff4903016ce83ef788b455e2c80ba9976e8e55ac6591b9f9965234a0a2c579269bc5e09577977322d07d17bb8d657ac621a1abfadcb35b9c9d4713dbdd3d47fd3cc6dc2475c989aa224fecd083101049ef1adea2718b00e37f84c8401e5c5cfa0be938dfeafe5b932c2dcef0e2bebb1a05f31104a59b49d78b0b7746a483c14648401e5c5d0a03658f0bb6692995a9dd3b72a69ec6e8e1b9af4361718d8a275c2b92d26eeffc28027cb6d065d5a6d8749ca45a185add61b9ce470136898643170f8072513ca45f35d826f02cb2494f857beebdac9ec04196c8b30a65352ef155a28ac6a0057ff1601"), forkSpecs)
		}
	}
}

func (ts *HeaderQueryTestSuite) TestSuccessQueryFinalizedHeaderFermi() {
	ts.Require().NoError(log.InitLogger("INFO", "json", "stdout", false))

	fn := func(ctx context.Context, height uint64) (*types.Header, error) {
		header := &types.Header{
			Number: big.NewInt(0).SetUint64(height),
		}
		var v []byte
		var err error
		if height == 506 {
			v, err = hex.DecodeString("f90370a061e54cba38225d35f042c6bd5ae8d6f981a451f3a53e49313b570db907ee2dd2a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0396436866456ceb1c4b702cb5d3a4b1e2495d84619f1ba7142b80e59e8342a88a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fa8402625a008084690eacdbb90111d983010602846765746889676f312e32342e3130856c696e757800000d382c2cf8ae07b86089aa2052e18ebe839aa3723bcad27b2a2196e22b7bc11c4d4d24d4a69e01e86bd404d19a0345c922456c8f6badd351d907fb69a6590bfad9673c8fdb9fc38bdd73b9bb4c93bb3d349380322366b1dc6d294e0e6916ef256ccbfa245255e43ad3f8488201f6a09058cfa000d451f4cd49092133047c1cf4a29d2c905a9aa17c890e96d81513d08201f8a0464df616013723293103002550e47ce3e44eb7dee4b11bfa10daeb4a2df51215802185ef1b54bfba22b6d1be5d4988c592b1da29abd380ea7d98def9b4f17e66f50b580baa6e8481b1b15b424ceddbf66964f633371d73a62825c67f9c633077d501a000000000000000000000000000000000000000000000000000000000000000c888000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 507 {
			v, err = hex.DecodeString("f902bfa06510e76fec4471a1dd46e83484608cba84a2c0860ed484dc785aaeca5bc24598a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0ed3a25beff351197a86ea87f939c7a129d7e7b9759a5c125875e58424c774c96a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fb8402625a008084690eacdbb861d983010602846765746889676f312e32342e3130856c696e757800000d382c2c9ed5d62372f22f62c2442552b80af1e868265d205a6132a44c10bbc50fe017bc1f9ad3f3c89381a992f177e292821630df0079134f002dcaaca675e5486b796400a0000000000000000000000000000000000000000000000000000000000000028a88000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 508 {
			v, err = hex.DecodeString("f90370a042ac9f2075511d2293a3448edba653bd1fe6cb7bf4b6fd9597d98bd3e1168eeea01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0027e1be8380711bbe9075b3d99dd23e59769711f03064b2a42f03c5a4ee2294da056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fc8402625a008084690eacdcb90111d983010602846765746889676f312e32342e3130856c696e757800000d382c2cf8ae07b8608509853e9fab817fba4600c12d1689548f6566e22277a0fbfc99c0c241e53362550e13bb2c1da81dd133a953539febce16760742ac3462ae106c4d7db8422bdb9e01f1d7285251940badbec7358f923e6ff267135f0c6e73963e5340edb495d7f8488201f8a0464df616013723293103002550e47ce3e44eb7dee4b11bfa10daeb4a2df512158201faa06510e76fec4471a1dd46e83484608cba84a2c0860ed484dc785aaeca5bc2459880d63a5ec69ce06dbbe045deffd2cf87000fe0b91a727973edbdb980ab86d80eee0e272ce2600c634d7ee5cb2d4f4b2139e924a6f6d6f818fda0ed8b02d69be61901a0000000000000000000000000000000000000000000000000000000000000006488000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 509 {
			v, err = hex.DecodeString("f902bfa04dbe87a2afcbd4599b997d68b7976c15d5d6c78fbaa2586541c6ab1a5d3051e9a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0c5b6d22e10686a802dfe562e6b2de199ebecf18aae5a284aa531fd4137fdcd3ea056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fd8402625a008084690eacdcb861d983010602846765746889676f312e32342e3130856c696e757800000d382c2caf975e1c326acf700081afa54cc4b2a84fb67ec15733488c488cf2b2c4c22862646c5b21762fe5df77abfbc6076eccaaf445af23e584b33cf602f7134125999500a0000000000000000000000000000000000000000000000000000000000000022688000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 510 {
			v, err = hex.DecodeString("f90370a0fca3ee6eb6331d3caf5310dcea500b6d06ea5dee08972a285d3c8bcf2848e542a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347948fdaaa7e6631e438625ca25c857a3727ea28e565a06bfb3c7904a7b6347689fea2fc0ad3e0bcc6597d4817c9ce132e8a4962b740e2a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fe8402625a008084690eacddb90111d983010602846765746889676f312e32342e3130856c696e757800000d382c2cf8ae07b860ab54b1e139a3e5345731e228daccb85fa7641a6f4873057022d1f6979c69b2d4193d96068a9c23ea7f0540f7f2bf8e210493a01df523bc4e8b15f02c772425bbfd8577e33cb603b6d8349834cd678e4e15799e141d2bd15dba147302116566fcf8488201faa06510e76fec4471a1dd46e83484608cba84a2c0860ed484dc785aaeca5bc245988201fca04dbe87a2afcbd4599b997d68b7976c15d5d6c78fbaa2586541c6ab1a5d3051e9809de85618105acd64900a429445efd27d81e587f6dca6a8e4ea0ad219111078ec0696d6064a4b8e7251883f0cb52f2fa5e33389fc934b11be1b581c357d46bca600a0000000000000000000000000000000000000000000000000000000000000000088000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 780 {
			v, err = hex.DecodeString("f902bfa0c9e4ade6549940a3176549973e104db99f5d76414a75dac85c5c7d8ac4944c02a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a07af9c8b256e0568fefd01da65fc184d2b99ddbc941bb73f8c1a4a88b4829733ca056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282030c8402625a008084690ec149b861d983010602846765746889676f312e32342e3130856c696e75780000c2625646e9f66472b1e36d0741b3a83cbb5bd08c15a2fd0d7221d740fa2cabe6fd732af37c0f21fc754af73a60d342c9361fb181d88d31559932c6ad48d6b2100e8d0cb801a000000000000000000000000000000000000000000000000000000000000000c888000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 781 {
			v, err = hex.DecodeString("f90370a06fba6c4d22a8bbeeabab7ed42399df6d1e5619583c2fa5c8501ab92fed48a008a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a03619e2f634b93ad603a07e2cd8f74972b76430a2717ada94d8a514a41c305548a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282030d8402625a008084690ec149b90111d983010602846765746889676f312e32342e3130856c696e75780000c2625646f8ae03b86090555af20ed36f5aabeb62da55f3375f12579bdc1a879f5313c5d9c56b413e3eeb284aa748fb42e39553c15e3d54cb9c01d2aeaa6ad89fe64c3fe291e773e6935a7ea5dbf399cd4654555a82f6d4701b85f4f75b93cc2f57fcdcb949f87e54a0f848820307a024b038aa32c2b8788a5dd68a43d5d35425d00213fc6f61e7c35e1774a6519cdc82030aa0cad7cf4aefc3ec5ca95b1039846bc3faccc900fe1f0a798ea63f801f337588358077a98dfbef98d18c23c0d5b424124afe304dc22f50b5aadbf3f93cd1feac4e76448716c07cc72502f7a033a1ab6850ce30bc21f16240a2705bea1f7fe9403a3e00a0000000000000000000000000000000000000000000000000000000000000028a88000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 782 {
			v, err = hex.DecodeString("f902bfa0d55e5ceb7a93760e0c614643e8d181c5d3c65d2c6ad80d4343a5935a9ac037caa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a0506ec5106e98498ec95882fcd5f03dfbaae3c61a552d3e5308db4dbf4763e5c5a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282030e8402625a008084690ec14ab861d983010602846765746889676f312e32342e3130856c696e75780000c26256461e8802da3c1054ff83171c0a1b235cc70ba935d52841d7b9e60ed0bde9a3a9d31fe7d19f9a818b7426b8070a6713198cc0ed936785c05611481fad81cf3c694c01a0000000000000000000000000000000000000000000000000000000000000006488000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 783 {
			v, err = hex.DecodeString("f902bfa0342d99d1728fd05ac3a821162f7cff5569a62d0d09c78277c9e701e4b7ac4883a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a002874b20b003e0afd996d22c352c8a8ec8bc0b0986743a96fad3cd5e81cbd0d4a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282030f8402625a008084690ec14ab861d983010602846765746889676f312e32342e3130856c696e75780000c26256466815abc1b4b5c335ad0a1ed2bd17a021211d5b1f8d75b2c4dc7ab26ce8a5486f425ed9645510451596affdc1e602ead6dca707266f188544b02c2d247d1832ef00a0000000000000000000000000000000000000000000000000000000000000022688000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 784 {
			v, err = hex.DecodeString("f90370a044122401ce9e6f2bbd26016c1c6ec98f09f9d2a3f7b50dd838561b3aebdc74bca01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0625fb0ac90a3457ceda3880024019e6ee61dbfdadd78e7386025cb8c29ed9069a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028203108402625a008084690ec14bb90111d983010602846765746889676f312e32342e3130856c696e75780000c2625646f8ae03b8608ee466a4507c0ed1cfc0e119d9e4e1d25c1c82047d65886cbc58c25adb71c661f5ab6c48e97ee4e84515091d93ff978b02cf9514f22b413b455a629e25f7162a02e551f7609b7e4dc8d5f83347b8b524e78fa211ced41fc04478ea6efe7b1e78f84882030aa0cad7cf4aefc3ec5ca95b1039846bc3faccc900fe1f0a798ea63f801f3375883582030da0d55e5ceb7a93760e0c614643e8d181c5d3c65d2c6ad80d4343a5935a9ac037ca802b77e755536d4064ee5c0366e175260503bb8dbfe7295c533175302de08be87e5e336eaf138730cd57069f2002d2646dca55e525d283897c62f7eeb0a9ff5c9f01a0000000000000000000000000000000000000000000000000000000000000000088000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 785 {
			v, err = hex.DecodeString("f902bfa060408654260d46aabcf65cf0dd8b29b95599b55380ea57857b29f723adc443fda01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a051ac73c5703c15e58e98df4e118219b601034918cc803e00041ed0618cf8e960a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028203118402625a008084690ec14bb861d983010602846765746889676f312e32342e3130856c696e75780000c262564692a109b1b71100625a7312aad649212af6c20ed6fa698bf0cfaf71b52bbe54af7f32815be4c7df330df25c2a2cdcafaa126ba01b17a69c41bb14fafab8352b0301a000000000000000000000000000000000000000000000000000000000000001c288000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 786 {
			v, err = hex.DecodeString("f902bfa02feea8d1b311b45029924cf412d39b6e9898d664ae659bf7c3e3a25df3defeb3a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a054f8faa7215319277fa00eae4bf3886dbe7adb37c8a8968207e46bc4a073781da056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028203128402625a008084690ec14bb861d983010602846765746889676f312e32342e3130856c696e75780000c26256469322825fd21edfdd57dac75a867dc4060e3b234e16f771b1e186f1e2a399b7242f8b59f3fb1ea9b08228c3c12692628ac1664a75177640c862415f261481b7f300a0000000000000000000000000000000000000000000000000000000000000038488000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 787 {
			v, err = hex.DecodeString("f90370a0f2880c072f0674e90a40006553f5a28758f78902268f17e0f8b8cdcf0bea04fda01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a001a48ccfc24533e019befebeef5131644d239fb5fc4756a7c7e251a2bdc0a231a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028203138402625a008084690ec14cb90111d983010602846765746889676f312e32342e3130856c696e75780000c2625646f8ae03b860b63fd76261cb5cc16f53e82133c937e2042443bddf92b8d55982c69360241067d0b707604972b10ab624d2ded8d411b71760bc28ffe89c5906595a3a43135e9678c025fe8694b77a859674bc2c0dfc9abaa58640ab6b43f607facb410d087023f84882030da0d55e5ceb7a93760e0c614643e8d181c5d3c65d2c6ad80d4343a5935a9ac037ca820310a060408654260d46aabcf65cf0dd8b29b95599b55380ea57857b29f723adc443fd80108f12a9c98aa2d2c3944a3bb0f45c0c2e479549a84f6a0ce5741475229c12ca2242d904fa10057e2dfd5ab42a4b06d1201c2565005763eda37bc060cfa00fc200a0000000000000000000000000000000000000000000000000000000000000015e88000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
			// testnet
		} else if height == 72486608 {
			v, err = hex.DecodeString("f9037aa0927229adbeb44087068093a2d84ee4a537840124ae4b6143b6a00eb69861b154a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347947f5f2cf1aec83bf0c74df566a41aa7ed65ea84eaa09758bd6b22c47cbab71682ebe5a0d491d6fd602030c36191b1c452108b12ce9ba0c10ee260e1302f2968d14030935957e496a45c186e00c506401e5d1d3206dba3a09d5348954d8cc85a4f7a3d8f7782fa98168746ea673c93618a21f6b67cbd7596b90100c0c010d01000192108c080c08714a30000a00c5c86022108452210200a0007d190d113020b49e801800048285140e07441112051ea0500804314204006202941000944810a8a18330100000cc10009003990b30040c9071524349270cae14094027a20fdd20a00a19a100008106808408a2090c4030e010c00086512280a8383c6222cdd100415000020802406424800408847862421c16e1219010801b09023020429534974532168000c004a0010440880006220001280184848b0850800a0cb00173e886a292850c206104b1792a353820810280458512094508a92202301181640020864682009034c668c8115e102018032e1a97a00480720000040081a028404520ed0840393870083a7a3cb846915a242b90116d883010603846765746888676f312e32342e39856c696e75780000005b240570f8b381ffb8608fe47768d7664ebd7100b41eab5ec8ba81d0d18a823b0558894c28512e8b9011c08ff5fd8835d7c5162fae4eedc9c12710a236ee5b399028a5856cbc79e0db6ae627bd06cdf638a5aab208dc141c5156bf9cc9a791bd3842b00f2aff393239b1f84c8404520ecea0f07121ac67d5ac8171d16d6dd53a968160e091ea3346fcfa6bdb53c4bbb4c8fa8404520ecfa0927229adbeb44087068093a2d84ee4a537840124ae4b6143b6a00eb69861b154801b31de7aecb339fcfb2b43796eadaf626c43892ec60caeb3b5a2663337f93a8241bbe3dccacb4548234f9972a3e1ff2d20675a25bfa6ee9b00f55471575915a701a000000000000000000000000000000000000000000000000000000000000001c288000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 72486609 {
			v, err = hex.DecodeString("f902c4a015dd14d86358864bd7c4422cd74f2736031572dc7f6dc0acc5e04dd54c3bd6ffa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347947f5f2cf1aec83bf0c74df566a41aa7ed65ea84eaa066ef3ab3f6400aa818434f02469813592133534dbb453377fb493adc78adc118a03ba925fd87820072d58827d2a661a5f7937e6b49a04baabc9d146b6b26e52c56a0bf08758ce3cb32054ce1a2476fcaed8c0cea284f997335617473b9ebf7c19b12b90100a00029800000801e282228c0879843c020401040000931108620b2320e0025428010941033013001107108a018c4e8242100de1011848400e154000042a16014004940e12a0201476072464c6c100208b1d88500118000040634126822210040088af0f08202c213cc1430881020080188039008a248203e10054932c048c03100620c9240848c0a6520c4c244105900008807e10021046c229003800ce09127f30a0c10e4446168e8830c0002218000800241010519020032508010c0040c610900d14e2060081800900702017390227080702028400cd5289440439005b488119256022050e000499154c6c08801050a05904020a80008c20120480018003b028404520ed18403938700839d895a846915a242b861d883010603846765746888676f312e32342e39856c696e75780000005b24057070e3f36857d8a5d61002abfa41c9d2ab6d930cccd00f2a14858ad50a7871f6f61d63bf98101465e416efe7c1b3fb5ef7ca05d1b5f4b5cd389a8df39d95da9aab01a0000000000000000000000000000000000000000000000000000000000000038488000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 72486610 {
			v, err = hex.DecodeString("f9037aa0f1f70f9eade2a06caf03876dbe5b77acc355290bde28c21e758201931b7d06dca01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347947f5f2cf1aec83bf0c74df566a41aa7ed65ea84eaa08b0e7d3df3a0d279160c7107d5b3c984c86c4db3cae65e1f057bf65f24f74bd7a062f2227465041b8a0729419b66744ce934dfd44ded3c89e98b64c66d854435f4a0a27c94fe9db012ddc0510d673bc2e151e1122fdf51617438e4da525da59e3002b9010020005084c0041821480001cb87001910224000c88000188904a411221a8015440114134c83416e8000020c28204160224302931008854815c114102096a0222260094082030211130800081d4280502021b1830810000000001c1a0242e36580002a20a0728e465288200580309e8812ca4130d08608c209800010180290100911027c989414ac01c0e688040500d883c43885121020226c0a1a4000012cb32147034c1000646020680226109a0010000000300400c02a094242a81002b2022039010186c162100243894613118b10a240002a8040800858215649821e0471480211503a054344540961c44500a813050201800080b224054c0920c00a00003b028404520ed2840393870083b91464846915a243b90116d883010603846765746888676f312e32342e39856c696e75780000005b240570f8b381fbb8608fd418669062ac8634bd8bb199e882e7b8b397eea7773ebb486d376405948cd00585ad5cf65458afbb939d2d862ec94d0cc95f43da645429aa847f6b373a73377ebbc9a4d74bf12c543eba4116db83f4dd0393c9aa91c87c853c1fa102bed78bf84c8404520ecfa0927229adbeb44087068093a2d84ee4a537840124ae4b6143b6a00eb69861b1548404520ed0a015dd14d86358864bd7c4422cd74f2736031572dc7f6dc0acc5e04dd54c3bd6ff80b6a41393fe771b9a5b5f7c397ff9ef5c8aa3e4a1fc5f7be3be5d3d36cf6f2f544f5d96dc9619db54aad30307aa055197a53207b57d0bd4bee7e2f1d04affc47600a0000000000000000000000000000000000000000000000000000000000000015e88000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 72486611 {
			v, err = hex.DecodeString("f90379a0bfde5240efbf9dda1381cf5ead3039a1c6b55c5dae95cb044c23fc2c2611f379a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347947f5f2cf1aec83bf0c74df566a41aa7ed65ea84eaa0c139cd27cf0c4981fab2ad057854aeff51f9c416d97a733d3cff4d8fc80fcac5a0822ba47aed5ce6f1b995eb5f9f85635e8f330b5642835fd5feaedb310e056571a0666894d3380ee97be17bcb46ce09f1c585917458d6a92be7aeb81b6a466d56cdb9010001210080122011352a0868c0c79281001778024088800008062050700f224540001b9441134370280d2008a4b009e02409050b1001050020f334122406622407000950e00a4324030020046ec00450142195c1280248000830841701022fa022808b20a0032308480820d7003c2008220b18d25c5209004c060040b10404292100120cd050a4840900209901fc20490520480f200221105c225100810020902be2048910244d4268683005000a2200008200038920181b0030498810000080a68d004586086c20a080880e11011390221a00100041900e5031b4438a1800a05008546002004050980f095cc61cb00b000313808090a000226001318091c0095b028404520ed38403938700839d2605846915a243b90115d883010603846765746888676f312e32342e39856c696e75780000005b240570f8b27fb860b256cac937e461138b0c95cd43c783efad7ae7c1bff57bf9c2366eaee6a8ffface7e809ea699b8e4f6bf5659fed22d72001fd1f7d3038bbe44036711d56140c2c9f5e1e91a6473e884bebe374dabf6b9f61d547e8ed93f908c449e18d6f65843f84c8404520ed0a015dd14d86358864bd7c4422cd74f2736031572dc7f6dc0acc5e04dd54c3bd6ff8404520ed2a0bfde5240efbf9dda1381cf5ead3039a1c6b55c5dae95cb044c23fc2c2611f379809fbce16268145ce40e6e8e7928b4a3719ff036f5814c5a22ebd4b15af108892e169598a3b849d0d069162550728367af38819a3ea79133cd3dff51ae58e8299100a0000000000000000000000000000000000000000000000000000000000000032088000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		}
		ts.Require().NoError(err)
		if v != nil {
			ts.Require().NoError(rlp.DecodeBytes(v, header))
		}
		return header, nil
	}
	starts := [][]uint64{
		{506, 510 - 506 + 1, 1000}, {780, 787 - 780 + 1, 1000},
		{506, 510 - 506 + 1, 510}, {780, 787 - 780 + 1, 787},
		{506, 0, 509}, {780, 0, 786},
		{72486608, 72486611 - 72486608 + 1, 72486611}, {72486608, 72486611 - 72486608 + 1, 72486611 + 1000},
		{72486608, 0, 72486610},
	}
	for _, start := range starts {
		headers, err := queryFinalizedHeader(context.Background(), fn, start[0], start[2], ts.forkSpecsPatterns[1])
		ts.Require().NoError(err)
		ts.Require().Len(headers, int(start[1]), len(headers))
		number := start[0] - 1
		for _, h := range headers {
			var header types.Header
			ts.Require().NoError(rlp.DecodeBytes(h.Header, &header))
			ts.Require().Equal(number+1, header.Number.Uint64())
			number = header.Number.Uint64()
		}
	}
}
