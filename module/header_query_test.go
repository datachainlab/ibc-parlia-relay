package module

import (
	"context"
	"encoding/hex"
	"math/big"
	"strings"
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/rlp"
	"github.com/hyperledger-labs/yui-relayer/log"
	"github.com/stretchr/testify/suite"
)

type HeaderQueryTestSuite struct {
	suite.Suite
	forkSpecsPatterns [][]*ForkSpec
}

func TestHeaderQueryTestSuite(t *testing.T) {
	suite.Run(t, new(HeaderQueryTestSuite))
}

func (ts *HeaderQueryTestSuite) SetupTest() {
	err := log.InitLogger("DEBUG", "text", "stdout", false)
	ts.Require().NoError(err)
	ts.forkSpecsPatterns = [][]*ForkSpec{
		{{
			HeightOrTimestamp:        &ForkSpec_Height{Height: 0},
			KAncestorGenerationDepth: 1,
		}},
		{{
			HeightOrTimestamp:        &ForkSpec_Height{Height: 0},
			KAncestorGenerationDepth: 3,
		}},
	}
}

func (ts *HeaderQueryTestSuite) TestErrorQueryFinalizedHeader() {

	ts.Require().NoError(log.InitLogger("INFO", "json", "stdout", false))
	fn := func(ctx context.Context, height uint64) (*types.Header, error) {
		return &types.Header{
			Number: big.NewInt(int64(height)),
		}, nil
	}

	for _, forkSpecs := range ts.forkSpecsPatterns {
		// No finalized header found
		headers, err := queryFinalizedHeader(context.Background(), fn, 1, 10, forkSpecs)
		ts.Require().NoError(err)
		ts.Require().Nil(headers)

		fn = func(ctx context.Context, height uint64) (*types.Header, error) {
			h := headerByHeight(int64(height))
			if h != nil {
				return h, nil
			}
			return &types.Header{Number: big.NewInt(int64(height))}, nil
		}

		headers, err = queryFinalizedHeader(context.Background(), fn, 760, 1000, forkSpecs)
		ts.Require().NoError(err)
		ts.Require().Nil(headers)
	}

}

func (ts *HeaderQueryTestSuite) TestSuccessQueryFinalizedHeader() {
	ts.Require().NoError(log.InitLogger("INFO", "json", "stdout", false))
	fn := func(ctx context.Context, height uint64) (*types.Header, error) {
		h := headerByHeight(int64(height))
		if h != nil {
			return h, nil
		}
		return &types.Header{Number: big.NewInt(int64(height))}, nil
	}

	for _, forkSpecs := range ts.forkSpecsPatterns {
		headers, err := queryFinalizedHeader(context.Background(), fn, 760, 1002, forkSpecs)
		ts.Require().NoError(err)
		ts.Require().Len(headers, 1002-760, len(headers))
	}
}

func (ts *HeaderQueryTestSuite) TestSuccessQueryLatestFinalizedHeader() {

	verify := func(latestBlockNumber uint64, forkSpecs []*ForkSpec) {
		getHeader := func(ctx context.Context, height uint64) (*types.Header, error) {
			h := headerByHeight(int64(height))
			if h != nil {
				return h, nil
			}
			return &types.Header{Number: big.NewInt(int64(height))}, nil
		}
		height, h, err := queryLatestFinalizedHeader(context.Background(), getHeader, latestBlockNumber, forkSpecs)
		ts.Require().NoError(err)
		ts.Require().Len(h, 3)
		ts.Require().Equal(int(height), 1001)
	}
	for _, forkSpecs := range ts.forkSpecsPatterns {
		for i := 1003; i < 1003+100; i++ {
			verify(uint64(i), forkSpecs)
		}
	}
}

func (ts *HeaderQueryTestSuite) TestErrorQueryLatestFinalizedHeader_NoVote() {

	verify := func(latestBlockNumber uint64, extra []byte, forkSpecs []*ForkSpec) {
		getHeader := func(ctx context.Context, height uint64) (*types.Header, error) {
			return &types.Header{
				Number: big.NewInt(int64(height)),
				Extra:  extra,
			}, nil
		}
		_, _, err := queryLatestFinalizedHeader(context.Background(), getHeader, latestBlockNumber, forkSpecs)
		ts.Require().True(strings.Contains(err.Error(), "no finalized header found"))
	}

	for _, forkSpecs := range ts.forkSpecsPatterns {
		for i := 0; i < 100; i++ {
			verify(uint64(i), make([]byte, 0), forkSpecs)
			verify(uint64(i), common.Hex2Bytes("d88301020b846765746888676f312e32302e35856c696e7578000000b19df4a2f8b5831defffb860a44482b16993815ff4903016ce83ef788b455e2c80ba9976e8e55ac6591b9f9965234a0a2c579269bc5e09577977322d07d17bb8d657ac621a1abfadcb35b9c9d4713dbdd3d47fd3cc6dc2475c989aa224fecd083101049ef1adea2718b00e37f84c8401e5c5cfa0be938dfeafe5b932c2dcef0e2bebb1a05f31104a59b49d78b0b7746a483c14648401e5c5d0a03658f0bb6692995a9dd3b72a69ec6e8e1b9af4361718d8a275c2b92d26eeffc28027cb6d065d5a6d8749ca45a185add61b9ce470136898643170f8072513ca45f35d826f02cb2494f857beebdac9ec04196c8b30a65352ef155a28ac6a0057ff1601"), forkSpecs)
		}
	}
}

func (ts *HeaderQueryTestSuite) TestSuccessQueryFinalizedHeaderFermi() {
	ts.Require().NoError(log.InitLogger("INFO", "json", "stdout", false))

	fn := func(ctx context.Context, height uint64) (*types.Header, error) {
		header := &types.Header{
			Number: big.NewInt(0).SetUint64(height),
		}
		var v []byte
		var err error
		if height == 506 {
			v, err = hex.DecodeString("f90370a061e54cba38225d35f042c6bd5ae8d6f981a451f3a53e49313b570db907ee2dd2a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0396436866456ceb1c4b702cb5d3a4b1e2495d84619f1ba7142b80e59e8342a88a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fa8402625a008084690eacdbb90111d983010602846765746889676f312e32342e3130856c696e757800000d382c2cf8ae07b86089aa2052e18ebe839aa3723bcad27b2a2196e22b7bc11c4d4d24d4a69e01e86bd404d19a0345c922456c8f6badd351d907fb69a6590bfad9673c8fdb9fc38bdd73b9bb4c93bb3d349380322366b1dc6d294e0e6916ef256ccbfa245255e43ad3f8488201f6a09058cfa000d451f4cd49092133047c1cf4a29d2c905a9aa17c890e96d81513d08201f8a0464df616013723293103002550e47ce3e44eb7dee4b11bfa10daeb4a2df51215802185ef1b54bfba22b6d1be5d4988c592b1da29abd380ea7d98def9b4f17e66f50b580baa6e8481b1b15b424ceddbf66964f633371d73a62825c67f9c633077d501a000000000000000000000000000000000000000000000000000000000000000c888000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 507 {
			v, err = hex.DecodeString("f902bfa06510e76fec4471a1dd46e83484608cba84a2c0860ed484dc785aaeca5bc24598a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0ed3a25beff351197a86ea87f939c7a129d7e7b9759a5c125875e58424c774c96a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fb8402625a008084690eacdbb861d983010602846765746889676f312e32342e3130856c696e757800000d382c2c9ed5d62372f22f62c2442552b80af1e868265d205a6132a44c10bbc50fe017bc1f9ad3f3c89381a992f177e292821630df0079134f002dcaaca675e5486b796400a0000000000000000000000000000000000000000000000000000000000000028a88000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 508 {
			v, err = hex.DecodeString("f90370a042ac9f2075511d2293a3448edba653bd1fe6cb7bf4b6fd9597d98bd3e1168eeea01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0027e1be8380711bbe9075b3d99dd23e59769711f03064b2a42f03c5a4ee2294da056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fc8402625a008084690eacdcb90111d983010602846765746889676f312e32342e3130856c696e757800000d382c2cf8ae07b8608509853e9fab817fba4600c12d1689548f6566e22277a0fbfc99c0c241e53362550e13bb2c1da81dd133a953539febce16760742ac3462ae106c4d7db8422bdb9e01f1d7285251940badbec7358f923e6ff267135f0c6e73963e5340edb495d7f8488201f8a0464df616013723293103002550e47ce3e44eb7dee4b11bfa10daeb4a2df512158201faa06510e76fec4471a1dd46e83484608cba84a2c0860ed484dc785aaeca5bc2459880d63a5ec69ce06dbbe045deffd2cf87000fe0b91a727973edbdb980ab86d80eee0e272ce2600c634d7ee5cb2d4f4b2139e924a6f6d6f818fda0ed8b02d69be61901a0000000000000000000000000000000000000000000000000000000000000006488000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 509 {
			v, err = hex.DecodeString("f902bfa04dbe87a2afcbd4599b997d68b7976c15d5d6c78fbaa2586541c6ab1a5d3051e9a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0c5b6d22e10686a802dfe562e6b2de199ebecf18aae5a284aa531fd4137fdcd3ea056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fd8402625a008084690eacdcb861d983010602846765746889676f312e32342e3130856c696e757800000d382c2caf975e1c326acf700081afa54cc4b2a84fb67ec15733488c488cf2b2c4c22862646c5b21762fe5df77abfbc6076eccaaf445af23e584b33cf602f7134125999500a0000000000000000000000000000000000000000000000000000000000000022688000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 510 {
			v, err = hex.DecodeString("f90370a0fca3ee6eb6331d3caf5310dcea500b6d06ea5dee08972a285d3c8bcf2848e542a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347948fdaaa7e6631e438625ca25c857a3727ea28e565a06bfb3c7904a7b6347689fea2fc0ad3e0bcc6597d4817c9ce132e8a4962b740e2a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028201fe8402625a008084690eacddb90111d983010602846765746889676f312e32342e3130856c696e757800000d382c2cf8ae07b860ab54b1e139a3e5345731e228daccb85fa7641a6f4873057022d1f6979c69b2d4193d96068a9c23ea7f0540f7f2bf8e210493a01df523bc4e8b15f02c772425bbfd8577e33cb603b6d8349834cd678e4e15799e141d2bd15dba147302116566fcf8488201faa06510e76fec4471a1dd46e83484608cba84a2c0860ed484dc785aaeca5bc245988201fca04dbe87a2afcbd4599b997d68b7976c15d5d6c78fbaa2586541c6ab1a5d3051e9809de85618105acd64900a429445efd27d81e587f6dca6a8e4ea0ad219111078ec0696d6064a4b8e7251883f0cb52f2fa5e33389fc934b11be1b581c357d46bca600a0000000000000000000000000000000000000000000000000000000000000000088000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 780 {
			v, err = hex.DecodeString("f902bfa0c9e4ade6549940a3176549973e104db99f5d76414a75dac85c5c7d8ac4944c02a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a07af9c8b256e0568fefd01da65fc184d2b99ddbc941bb73f8c1a4a88b4829733ca056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282030c8402625a008084690ec149b861d983010602846765746889676f312e32342e3130856c696e75780000c2625646e9f66472b1e36d0741b3a83cbb5bd08c15a2fd0d7221d740fa2cabe6fd732af37c0f21fc754af73a60d342c9361fb181d88d31559932c6ad48d6b2100e8d0cb801a000000000000000000000000000000000000000000000000000000000000000c888000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 781 {
			v, err = hex.DecodeString("f90370a06fba6c4d22a8bbeeabab7ed42399df6d1e5619583c2fa5c8501ab92fed48a008a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a03619e2f634b93ad603a07e2cd8f74972b76430a2717ada94d8a514a41c305548a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282030d8402625a008084690ec149b90111d983010602846765746889676f312e32342e3130856c696e75780000c2625646f8ae03b86090555af20ed36f5aabeb62da55f3375f12579bdc1a879f5313c5d9c56b413e3eeb284aa748fb42e39553c15e3d54cb9c01d2aeaa6ad89fe64c3fe291e773e6935a7ea5dbf399cd4654555a82f6d4701b85f4f75b93cc2f57fcdcb949f87e54a0f848820307a024b038aa32c2b8788a5dd68a43d5d35425d00213fc6f61e7c35e1774a6519cdc82030aa0cad7cf4aefc3ec5ca95b1039846bc3faccc900fe1f0a798ea63f801f337588358077a98dfbef98d18c23c0d5b424124afe304dc22f50b5aadbf3f93cd1feac4e76448716c07cc72502f7a033a1ab6850ce30bc21f16240a2705bea1f7fe9403a3e00a0000000000000000000000000000000000000000000000000000000000000028a88000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 782 {
			v, err = hex.DecodeString("f902bfa0d55e5ceb7a93760e0c614643e8d181c5d3c65d2c6ad80d4343a5935a9ac037caa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a0506ec5106e98498ec95882fcd5f03dfbaae3c61a552d3e5308db4dbf4763e5c5a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282030e8402625a008084690ec14ab861d983010602846765746889676f312e32342e3130856c696e75780000c26256461e8802da3c1054ff83171c0a1b235cc70ba935d52841d7b9e60ed0bde9a3a9d31fe7d19f9a818b7426b8070a6713198cc0ed936785c05611481fad81cf3c694c01a0000000000000000000000000000000000000000000000000000000000000006488000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 783 {
			v, err = hex.DecodeString("f902bfa0342d99d1728fd05ac3a821162f7cff5569a62d0d09c78277c9e701e4b7ac4883a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a002874b20b003e0afd996d22c352c8a8ec8bc0b0986743a96fad3cd5e81cbd0d4a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282030f8402625a008084690ec14ab861d983010602846765746889676f312e32342e3130856c696e75780000c26256466815abc1b4b5c335ad0a1ed2bd17a021211d5b1f8d75b2c4dc7ab26ce8a5486f425ed9645510451596affdc1e602ead6dca707266f188544b02c2d247d1832ef00a0000000000000000000000000000000000000000000000000000000000000022688000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 784 {
			v, err = hex.DecodeString("f90370a044122401ce9e6f2bbd26016c1c6ec98f09f9d2a3f7b50dd838561b3aebdc74bca01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a0625fb0ac90a3457ceda3880024019e6ee61dbfdadd78e7386025cb8c29ed9069a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028203108402625a008084690ec14bb90111d983010602846765746889676f312e32342e3130856c696e75780000c2625646f8ae03b8608ee466a4507c0ed1cfc0e119d9e4e1d25c1c82047d65886cbc58c25adb71c661f5ab6c48e97ee4e84515091d93ff978b02cf9514f22b413b455a629e25f7162a02e551f7609b7e4dc8d5f83347b8b524e78fa211ced41fc04478ea6efe7b1e78f84882030aa0cad7cf4aefc3ec5ca95b1039846bc3faccc900fe1f0a798ea63f801f3375883582030da0d55e5ceb7a93760e0c614643e8d181c5d3c65d2c6ad80d4343a5935a9ac037ca802b77e755536d4064ee5c0366e175260503bb8dbfe7295c533175302de08be87e5e336eaf138730cd57069f2002d2646dca55e525d283897c62f7eeb0a9ff5c9f01a0000000000000000000000000000000000000000000000000000000000000000088000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 785 {
			v, err = hex.DecodeString("f902bfa060408654260d46aabcf65cf0dd8b29b95599b55380ea57857b29f723adc443fda01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794d9a13701eafb76870cb220843b8c6476824bfa15a051ac73c5703c15e58e98df4e118219b601034918cc803e00041ed0618cf8e960a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028203118402625a008084690ec14bb861d983010602846765746889676f312e32342e3130856c696e75780000c262564692a109b1b71100625a7312aad649212af6c20ed6fa698bf0cfaf71b52bbe54af7f32815be4c7df330df25c2a2cdcafaa126ba01b17a69c41bb14fafab8352b0301a000000000000000000000000000000000000000000000000000000000000001c288000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 786 {
			v, err = hex.DecodeString("f902bfa02feea8d1b311b45029924cf412d39b6e9898d664ae659bf7c3e3a25df3defeb3a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a054f8faa7215319277fa00eae4bf3886dbe7adb37c8a8968207e46bc4a073781da056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028203128402625a008084690ec14bb861d983010602846765746889676f312e32342e3130856c696e75780000c26256469322825fd21edfdd57dac75a867dc4060e3b234e16f771b1e186f1e2a399b7242f8b59f3fb1ea9b08228c3c12692628ac1664a75177640c862415f261481b7f300a0000000000000000000000000000000000000000000000000000000000000038488000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		} else if height == 787 {
			v, err = hex.DecodeString("f90370a0f2880c072f0674e90a40006553f5a28758f78902268f17e0f8b8cdcf0bea04fda01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a7876ea32e7a748c697d01345145485561305b24a001a48ccfc24533e019befebeef5131644d239fb5fc4756a7c7e251a2bdc0a231a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028203138402625a008084690ec14cb90111d983010602846765746889676f312e32342e3130856c696e75780000c2625646f8ae03b860b63fd76261cb5cc16f53e82133c937e2042443bddf92b8d55982c69360241067d0b707604972b10ab624d2ded8d411b71760bc28ffe89c5906595a3a43135e9678c025fe8694b77a859674bc2c0dfc9abaa58640ab6b43f607facb410d087023f84882030da0d55e5ceb7a93760e0c614643e8d181c5d3c65d2c6ad80d4343a5935a9ac037ca820310a060408654260d46aabcf65cf0dd8b29b95599b55380ea57857b29f723adc443fd80108f12a9c98aa2d2c3944a3bb0f45c0c2e479549a84f6a0ce5741475229c12ca2242d904fa10057e2dfd5ab42a4b06d1201c2565005763eda37bc060cfa00fc200a0000000000000000000000000000000000000000000000000000000000000015e88000000000000000080a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a00000000000000000000000000000000000000000000000000000000000000000a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")
		}
		ts.Require().NoError(err)
		if v != nil {
			ts.Require().NoError(rlp.DecodeBytes(v, header))
		}
		return header, nil
	}
	starts := [][]uint64{
		{506, 510 - 506 + 1, 1000}, {780, 787 - 780 + 1, 1000},
		{506, 510 - 506 + 1, 510}, {780, 787 - 780 + 1, 787},
		{506, 0, 509}, {780, 0, 786},
	}
	for _, start := range starts {
		headers, err := queryFinalizedHeader(context.Background(), fn, start[0], start[2], ts.forkSpecsPatterns[1])
		ts.Require().NoError(err)
		ts.Require().Len(headers, int(start[1]), len(headers))
		number := start[0] - 1
		for _, h := range headers {
			var header types.Header
			ts.Require().NoError(rlp.DecodeBytes(h.Header, &header))
			ts.Require().Equal(number+1, header.Number.Uint64())
			number = header.Number.Uint64()
		}
	}
}
